# Adapted from:
# https://github.com/status-im/nim-codex/blob/main/.github/workflows/ci.yml

name: Testground
on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        cache_nonce: [ 0 ] # Allows for easily busting actions/cache caches
        target:
          - os: linux
            cpu: amd64
        nim_branch: [version-1-2]
        include:
          - target:
              os: linux
            builder: ubuntu-latest
            shell: bash --noprofile --norc -eo pipefail

    defaults:
      run:
        shell: ${{ matrix.shell }} {0}
        working-directory: nim-codex

    name: '${{ matrix.target.os }}-${{ matrix.target.cpu }} (Nim ${{ matrix.nim_branch }})'
    runs-on: ${{ matrix.builder }}
    timeout-minutes: 80
    steps:
      - name: Checkout nim-codex sources
        uses: actions/checkout@v3
        with:
          path: nim-codex

      - name: Checkout Testground sources
        uses: actions/checkout@v3
        with:
          path: testground
          repository: testground/testground

      - name: APT (Linux amd64)
        if: runner.os == 'Linux' && matrix.target.cpu == 'amd64'
        run: |
          # sudo apt-fast update -qq
          # sudo DEBIAN_FRONTEND='noninteractive' apt-fast install \
          #   --no-install-recommends -yq ...

      - name: Derive environment variables
        run: |
          # Add executables built with Go to PATH
          echo "${HOME}/go/bin" >> ${GITHUB_PATH}

      - name: Calculate cache-key components
        id: calc-cache-key-components
        run: |
          cd ../testground
          echo "::set-output name=hash::$(git rev-parse $(git branch --show-current))"

      # - name: Restore Testground executable from cache
      #   id: testground-exe-cache
      #   uses: actions/cache@v3
      #   with:
      #     path: ~/go/bin/testground
      #     key: ${{ matrix.target.os }}-${{ matrix.target.cpu }}-nim-${{ matrix.nim_branch }}-testground_commit-${{ steps.calc-cache-key-components.outputs.hash }}-cache_nonce:${{ matrix.cache_nonce }}

      - name: Build Testground executable
        if: steps.testground-exe-cache.outputs.cache-hit != 'true'
        run: make install
        working-directory: testground

      - name: Start Testground executable
        run: testground daemon &

      - name: Build and run a Codex Testground plan with custom options
        run: |
          make \
            TESTGROUND_PLAN=simple_libp2p \
            TESTGROUND_OPTIONS="--instances=10 --wait" \
            testground
